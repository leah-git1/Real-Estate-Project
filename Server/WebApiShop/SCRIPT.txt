-- 1. יצירת מסד הנתונים
CREATE DATABASE RealEstateDB;
GO

-- 2. מעבר לשימוש במסד הנתונים שיצרנו
USE RealEstateDB;
GO

-- 3. יצירת טבלת משתמשים (Users)
CREATE TABLE Users (
    UserID INT PRIMARY KEY IDENTITY(1,1),
    FullName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(100) UNIQUE NOT NULL,
    Password NVARCHAR(255) NOT NULL,
    Phone NVARCHAR(20),
    Address NVARCHAR(MAX),
    IsAdmin BIT DEFAULT 0 -- 0 למשתמש רגיל, 1 למנהל
);

-- 4. יצירת טבלת קטגוריות (Categories)
-- דוגמה: מכירה, השכרה לטווח ארוך, נופש (טווח קצר)
CREATE TABLE Categories (
    CategoryID INT PRIMARY KEY IDENTITY(1,1),
    CategoryName NVARCHAR(50) NOT NULL,
    Description NVARCHAR(500)
);

-- 5. יצירת טבלת דירות/מוצרים (Products)
CREATE TABLE Products (
    ProductID INT PRIMARY KEY IDENTITY(1,1),
    Title NVARCHAR(200) NOT NULL,
    Description NVARCHAR(MAX),
    Price DECIMAL(18, 2) NOT NULL,
    ImageUrl NVARCHAR(MAX),
    CategoryID INT,
    City NVARCHAR(100),
    Rooms INT,
    Beds INT DEFAULT 0,
    OwnerID INT, -- מי המשתמש שהעלה את הדירה
    IsAvailable BIT DEFAULT 1, -- האם הדירה רלוונטית כרגע
    CreatedDate DATETIME DEFAULT GETDATE(),
    
    -- קשרים (Foreign Keys)
    CONSTRAINT FK_Product_Category FOREIGN KEY (CategoryID) REFERENCES Categories(CategoryID),
    CONSTRAINT FK_Product_Owner FOREIGN KEY (OwnerID) REFERENCES Users(UserID)
);

-- 6. יצירת טבלת הזמנות (Orders)
CREATE TABLE Orders (
    OrderID INT PRIMARY KEY IDENTITY(1,1),
    UserID INT NOT NULL, -- מי הקונה
    OrderDate DATETIME DEFAULT GETDATE(),
    TotalAmount DECIMAL(18, 2) NOT NULL, -- מחיר סופי כולל עמלה
    Status NVARCHAR(50) DEFAULT 'Pending', -- סטטוס: Pending, Completed, Cancelled
    
    CONSTRAINT FK_Order_User FOREIGN KEY (UserID) REFERENCES Users(UserID)
);

-- 7. יצירת טבלת פרטי הזמנה (OrderItems)
-- מחברת בין הזמנה לדירה ספציפית
CREATE TABLE OrderItems (
    OrderItemID INT PRIMARY KEY IDENTITY(1,1),
    OrderID INT NOT NULL,
    ProductID INT NOT NULL,
    PriceAtPurchase DECIMAL(18, 2) NOT NULL, -- המחיר ברגע הרכישה (תיעוד היסטורי)
    
    CONSTRAINT FK_Item_Order FOREIGN KEY (OrderID) REFERENCES Orders(OrderID),
    CONSTRAINT FK_Item_Product FOREIGN KEY (ProductID) REFERENCES Products(ProductID)
);

-- יצירת טבלת תמונות נוספות למוצר
CREATE TABLE ProductImages (
    ImageID INT PRIMARY KEY IDENTITY(1,1),
    ProductID INT NOT NULL, -- קישור לדירה הספציפית
    AdditionalImageUrl NVARCHAR(MAX) NOT NULL, -- הקישור לתמונה הנוספת
    
    -- יצירת קשר לטבלת מוצרים: אם מוצר נמחק, גם התמונות שלו יימחקו (CASCADE)
    CONSTRAINT FK_ProductImages_Products FOREIGN KEY (ProductID) 
    REFERENCES Products(ProductID) ON DELETE CASCADE
);
